{"mappings":"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","sources":["<anon>","probPoolComplete/main.ts","node_modules/stats.js/build/stats.min.js","kommon/kommon.ts"],"sourcesContent":["(function () {\nfunction $parcel$interopDefault(a) {\n  return a && a.__esModule ? a.default : a;\n}\nvar $parcel$global =\ntypeof globalThis !== 'undefined'\n  ? globalThis\n  : typeof self !== 'undefined'\n  ? self\n  : typeof window !== 'undefined'\n  ? window\n  : typeof global !== 'undefined'\n  ? global\n  : {};\nvar $parcel$modules = {};\nvar $parcel$inits = {};\n\nvar parcelRequire = $parcel$global[\"parcelRequire94c2\"];\nif (parcelRequire == null) {\n  parcelRequire = function(id) {\n    if (id in $parcel$modules) {\n      return $parcel$modules[id].exports;\n    }\n    if (id in $parcel$inits) {\n      var init = $parcel$inits[id];\n      delete $parcel$inits[id];\n      var module = {id: id, exports: {}};\n      $parcel$modules[id] = module;\n      init.call(module.exports, module, module.exports);\n      return module.exports;\n    }\n    var err = new Error(\"Cannot find module '\" + id + \"'\");\n    err.code = 'MODULE_NOT_FOUND';\n    throw err;\n  };\n\n  parcelRequire.register = function register(id, init) {\n    $parcel$inits[id] = init;\n  };\n\n  $parcel$global[\"parcelRequire94c2\"] = parcelRequire;\n}\n\nvar $6MzNI = parcelRequire(\"6MzNI\");\nvar $a759912a70d9e191$exports = {};\n// stats.js - http://github.com/mrdoob/stats.js\n(function(f, e) {\n    $a759912a70d9e191$exports = e();\n})($a759912a70d9e191$exports, function() {\n    var f = function() {\n        function e(a) {\n            c.appendChild(a.dom);\n            return a;\n        }\n        function u(a) {\n            for(var d = 0; d < c.children.length; d++)c.children[d].style.display = d === a ? \"block\" : \"none\";\n            l = a;\n        }\n        var l = 0, c = document.createElement(\"div\");\n        c.style.cssText = \"position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000\";\n        c.addEventListener(\"click\", function(a) {\n            a.preventDefault();\n            u(++l % c.children.length);\n        }, !1);\n        var k = (performance || Date).now(), g = k, a = 0, r = e(new f.Panel(\"FPS\", \"#0ff\", \"#002\")), h = e(new f.Panel(\"MS\", \"#0f0\", \"#020\"));\n        if (self.performance && self.performance.memory) var t = e(new f.Panel(\"MB\", \"#f08\", \"#201\"));\n        u(0);\n        return {\n            REVISION: 16,\n            dom: c,\n            addPanel: e,\n            showPanel: u,\n            begin: function() {\n                k = (performance || Date).now();\n            },\n            end: function() {\n                a++;\n                var c = (performance || Date).now();\n                h.update(c - k, 200);\n                if (c > g + 1E3 && (r.update(1E3 * a / (c - g), 100), g = c, a = 0, t)) {\n                    var d = performance.memory;\n                    t.update(d.usedJSHeapSize / 1048576, d.jsHeapSizeLimit / 1048576);\n                }\n                return c;\n            },\n            update: function() {\n                k = this.end();\n            },\n            domElement: c,\n            setMode: u\n        };\n    };\n    f.Panel = function(e, f, l) {\n        var c = Infinity, k = 0, g = Math.round, a = g(window.devicePixelRatio || 1), r = 80 * a, h = 48 * a, t = 3 * a, v = 2 * a, d = 3 * a, m = 15 * a, n = 74 * a, p = 30 * a, q = document.createElement(\"canvas\");\n        q.width = r;\n        q.height = h;\n        q.style.cssText = \"width:80px;height:48px\";\n        var b = q.getContext(\"2d\");\n        b.font = \"bold \" + 9 * a + \"px Helvetica,Arial,sans-serif\";\n        b.textBaseline = \"top\";\n        b.fillStyle = l;\n        b.fillRect(0, 0, r, h);\n        b.fillStyle = f;\n        b.fillText(e, t, v);\n        b.fillRect(d, m, n, p);\n        b.fillStyle = l;\n        b.globalAlpha = .9;\n        b.fillRect(d, m, n, p);\n        return {\n            dom: q,\n            update: function(h, w) {\n                c = Math.min(c, h);\n                k = Math.max(k, h);\n                b.fillStyle = l;\n                b.globalAlpha = 1;\n                b.fillRect(0, 0, r, m);\n                b.fillStyle = f;\n                b.fillText(g(h) + \" \" + e + \" (\" + g(c) + \"-\" + g(k) + \")\", t, v);\n                b.drawImage(q, d + a, m, n - a, p, d, m, n - a, p);\n                b.fillRect(d + n - a, m, a, p);\n                b.fillStyle = l;\n                b.globalAlpha = .9;\n                b.fillRect(d + n - a, m, a, g((1 - h / w) * p));\n            }\n        };\n    };\n    return f;\n});\n\n\nfunction $e28a0cada894885c$export$9f0c37400c701bee(n, callback) {\n    let result = Array(n);\n    for(let k = 0; k < n; k++)result[k] = callback(k);\n    return result;\n}\nfunction $e28a0cada894885c$export$f01e84010c13cebe(lo, hi, callback) {\n    let count = hi - lo;\n    let result = Array(count);\n    for(let k = 0; k < count; k++)result[k] = callback(k + lo);\n    return result;\n}\nfunction* $e28a0cada894885c$export$8901015135f2fb22(...arrays) {\n    let iterators = arrays.map((a)=>a[Symbol.iterator]());\n    while(true){\n        let nexts = iterators.map((a)=>a.next());\n        let done = nexts.some((n)=>n.done);\n        if (done) return;\n        yield nexts.map((n)=>n.value);\n    }\n}\nfunction $e28a0cada894885c$export$58aefef1ff9edd34(object, map_fn) {\n    let result = {};\n    for (let [k, v] of Object.entries(object))result[k] = map_fn(v);\n    return result;\n}\nclass $e28a0cada894885c$export$9341a022b2e0184a {\n    constructor(init_fn){\n        // typing doesn't work :(\n        let target = {};\n        return new Proxy(target, {\n            get: (target, name)=>{\n                if (name in target) return target[name];\n                else {\n                    target[name] = init_fn();\n                    return target[name];\n                }\n            }\n        });\n    }\n}\n\n\nvar $f0d3351cfec6cf4a$var$stats = new (0, (/*@__PURE__*/$parcel$interopDefault($a759912a70d9e191$exports)))();\n$f0d3351cfec6cf4a$var$stats.showPanel(0);\ndocument.body.appendChild($f0d3351cfec6cf4a$var$stats.dom);\n//// init\nconst $f0d3351cfec6cf4a$var$canvas = document.querySelector(\"#c\");\nconst $f0d3351cfec6cf4a$var$gl = $f0d3351cfec6cf4a$var$canvas.getContext(\"webgl2\", {\n    alpha: false\n});\n$f0d3351cfec6cf4a$var$gl.clearColor(0.5, 0.5, 0.75, 1.0);\n$f0d3351cfec6cf4a$var$gl.enable($f0d3351cfec6cf4a$var$gl.BLEND);\n$f0d3351cfec6cf4a$var$gl.blendFunc($f0d3351cfec6cf4a$var$gl.SRC_ALPHA, $f0d3351cfec6cf4a$var$gl.ONE_MINUS_SRC_ALPHA);\n// game logic\nconst $f0d3351cfec6cf4a$var$n_universes = 30000;\nconst $f0d3351cfec6cf4a$var$n_balls = 8;\nconst $f0d3351cfec6cf4a$var$ball_r = .05;\nconst $f0d3351cfec6cf4a$var$chaos = .01;\nconst $f0d3351cfec6cf4a$var$update_program = $6MzNI.createProgramFromSources($f0d3351cfec6cf4a$var$gl, [\n    // vs\n    `#version 300 es\r\n\r\n    precision highp float;\r\n\r\n    #define ball_r ${$f0d3351cfec6cf4a$var$ball_r.toFixed(10)}\r\n    #define bounce .9\r\n    #define drag .99\r\n    #define dt 0.01\r\n\r\n    ${(0, $e28a0cada894885c$export$9f0c37400c701bee)($f0d3351cfec6cf4a$var$n_balls, (i)=>{\n        return `in vec4 old_b${i}; out vec4 new_b${i};`;\n    }).join(\"\\n\")}\r\n\r\n    uniform vec2 u_impulse;\r\n\r\n    // pos, vel for each ball\r\n    void collide(in vec4 b1, in vec4 b2, out vec4 r1, out vec4 r2) {\r\n        r1 = b1;\r\n        r2 = b2;\r\n\r\n        vec2 delta = b1.xy - b2.xy;\r\n        float distSq = dot(delta, delta);\r\n        if (distSq > 0.0 && distSq < 4.0 * ball_r * ball_r) {\r\n            float dist = sqrt(distSq);\r\n            // assumption: all balls have the same mass\r\n            // intuition: the balls exchange their momentum\r\n            // but only on the direction joining them\r\n\r\n            // 1. avoid overlap\r\n            float push = (2.0 * ball_r - dist) * .5 * bounce / dist;\r\n            r1.xy += delta * push;\r\n            r2.xy -= delta * push;\r\n\r\n            // 2. exchange momentums\r\n            vec2 momentum = delta * (dot(delta, b1.zw) - dot(delta, b2.zw)) / distSq;\r\n            r1.zw -= momentum;\r\n            r2.zw += momentum;\r\n        }        \r\n    }\r\n\r\n    vec4 individualUpdate(vec4 ball) {\r\n        // movement\r\n        vec4 res = vec4(ball.xy + dt * ball.zw, ball.zw);\r\n        // bounce\r\n        if (abs(res.x) > 1.0 - ball_r) {\r\n            res.x = sign(res.x) * (2.0 - 2.0 * ball_r) - ball.x;\r\n            res.z = -ball.z;\r\n        }\r\n        if (abs(res.y) > 1.0 - ball_r) {\r\n            res.y = sign(res.y) * (2.0 - 2.0 * ball_r) - ball.y;\r\n            res.w = -ball.w;\r\n        }\r\n        // drag\r\n        res.zw *= drag;\r\n        return res;\r\n    }\r\n\r\n    void main() {\r\n        new_b0 = individualUpdate(vec4(old_b0.xy, old_b0.zw + u_impulse));\r\n    ${(0, $e28a0cada894885c$export$f01e84010c13cebe)(1, $f0d3351cfec6cf4a$var$n_balls, (i)=>{\n        return `new_b${i} = individualUpdate(old_b${i});`;\n    }).join(\"\\n\")}\r\n        // collision\r\n        // generate this code:\r\n        // collide(new_b0, new_b1, new_b0, new_b1);\r\n        // collide(0, 2) ...\r\n        // collide(0, n_balls-1)\r\n        // collide(1, 2) ...\r\n        // collide(1, n_balls-1)\r\n        // ...\r\n        // collide(n_balls - 2, n_balls-1)\r\n    ${(0, $e28a0cada894885c$export$f01e84010c13cebe)(0, $f0d3351cfec6cf4a$var$n_balls, (i)=>{\n        return (0, $e28a0cada894885c$export$f01e84010c13cebe)(i + 1, $f0d3351cfec6cf4a$var$n_balls, (j)=>{\n            return `collide(new_b${i}, new_b${j}, new_b${i}, new_b${j});`;\n        }).join(\"\\n\");\n    }).join(\"\\n\")}\r\n    }\r\n    `,\n    // fs\n    `#version 300 es\r\n    precision highp float;\r\n\r\n    void main() {}\r\n    `\n], {\n    transformFeedbackVaryings: (0, $e28a0cada894885c$export$f01e84010c13cebe)(0, $f0d3351cfec6cf4a$var$n_balls, (k)=>`new_b${k}`),\n    transformFeedbackMode: $f0d3351cfec6cf4a$var$gl.INTERLEAVED_ATTRIBS\n});\n// px,py,vx,vy for each ball\n// [b0px,b0py,b0vx,b0vy,b1...,b2...,b0px,b0py,b0vx,b0vy,b1...,b2...,....]\nconst $f0d3351cfec6cf4a$var$balldata_cpu = new Float32Array($f0d3351cfec6cf4a$var$n_universes * $f0d3351cfec6cf4a$var$n_balls * 4);\nfor(let b = 0; b < $f0d3351cfec6cf4a$var$n_balls; b++){\n    let start_px = (Math.random() - .5) * (2 - $f0d3351cfec6cf4a$var$ball_r);\n    let start_py = (Math.random() - .5) * (2 - $f0d3351cfec6cf4a$var$ball_r);\n    for(let k = 0; k < $f0d3351cfec6cf4a$var$n_universes; k++){\n        let base_index = (k * $f0d3351cfec6cf4a$var$n_balls + b) * 4;\n        $f0d3351cfec6cf4a$var$balldata_cpu[base_index + 0] = start_px;\n        $f0d3351cfec6cf4a$var$balldata_cpu[base_index + 1] = start_py;\n    }\n}\n// initial chaos\nfor(let k = 0; k < $f0d3351cfec6cf4a$var$n_universes; k++){\n    const ang = Math.PI * 2 * k / $f0d3351cfec6cf4a$var$n_universes;\n    $f0d3351cfec6cf4a$var$balldata_cpu[k * $f0d3351cfec6cf4a$var$n_balls * 4 + 0] += Math.cos(ang) * $f0d3351cfec6cf4a$var$chaos;\n    $f0d3351cfec6cf4a$var$balldata_cpu[k * $f0d3351cfec6cf4a$var$n_balls * 4 + 1] += Math.sin(ang) * $f0d3351cfec6cf4a$var$chaos;\n}\n// double buffer pattern\nconst $f0d3351cfec6cf4a$var$balldata_gpu_1 = $6MzNI.createBufferFromTypedArray($f0d3351cfec6cf4a$var$gl, $f0d3351cfec6cf4a$var$balldata_cpu, $f0d3351cfec6cf4a$var$gl.ARRAY_BUFFER, $f0d3351cfec6cf4a$var$gl.DYNAMIC_DRAW);\nconst $f0d3351cfec6cf4a$var$balldata_gpu_2 = $6MzNI.createBufferFromTypedArray($f0d3351cfec6cf4a$var$gl, $f0d3351cfec6cf4a$var$balldata_cpu, $f0d3351cfec6cf4a$var$gl.ARRAY_BUFFER, $f0d3351cfec6cf4a$var$gl.DYNAMIC_DRAW);\nconst $f0d3351cfec6cf4a$var$draw_pinfo = $6MzNI.createProgramInfo($f0d3351cfec6cf4a$var$gl, [\n    // vs\n    `#version 300 es\r\n\r\n    #define n_balls ${$f0d3351cfec6cf4a$var$n_balls.toFixed(10)}\r\n\r\n    in vec2 pos;\r\n\r\n    out vec3 v_ball_color;\r\n\r\n    vec3 hsl2rgb(in vec3 c) {\r\n        vec3 rgb = clamp( abs(mod(c.x*6.0+vec3(0.0,4.0,2.0),6.0)-3.0)-1.0, 0.0, 1.0 );\r\n        return c.z + c.y * (rgb-0.5)*(1.0-abs(2.0*c.z-1.0));\r\n    }\r\n\r\n\r\n    void main() {\r\n        gl_Position = vec4(pos, 0.0, 1.0);\r\n        gl_PointSize = ${($f0d3351cfec6cf4a$var$gl.canvas.width * 2 * $f0d3351cfec6cf4a$var$ball_r).toFixed(10)};\r\n        v_ball_color = hsl2rgb(vec3(float(gl_VertexID) / n_balls, 0.85, 0.5));\r\n        // v_ball_color = mix(vec3(1.0, 0, 0), vec3(0.0, 1, 0), mod(float(gl_VertexID), n_balls) / n_balls);\r\n    }\r\n    `,\n    // fs\n    `#version 300 es\r\n    precision highp float;\r\n\r\n    in vec3 v_ball_color;\r\n\r\n    out vec4 out_color;\r\n    \r\n    void main() {\r\n        float distSq = dot(gl_PointCoord - .5, gl_PointCoord - .5);\r\n        float alpha = smoothstep(.25, .20, distSq);\r\n        float outline = smoothstep(.27, .20, distSq);\r\n        out_color = vec4(v_ball_color * outline, alpha * .1);\r\n    }\r\n    `\n]);\nconst $f0d3351cfec6cf4a$var$draw_1_vao = $6MzNI.createVertexArrayInfo($f0d3351cfec6cf4a$var$gl, $f0d3351cfec6cf4a$var$draw_pinfo, $6MzNI.createBufferInfoFromArrays($f0d3351cfec6cf4a$var$gl, {\n    pos: {\n        buffer: $f0d3351cfec6cf4a$var$balldata_gpu_1,\n        numComponents: 2,\n        stride: 16,\n        type: Float32Array\n    }\n}));\nconst $f0d3351cfec6cf4a$var$draw_2_vao = $6MzNI.createVertexArrayInfo($f0d3351cfec6cf4a$var$gl, $f0d3351cfec6cf4a$var$draw_pinfo, $6MzNI.createBufferInfoFromArrays($f0d3351cfec6cf4a$var$gl, {\n    pos: {\n        buffer: $f0d3351cfec6cf4a$var$balldata_gpu_2,\n        numComponents: 2,\n        stride: 16,\n        type: Float32Array\n    }\n}));\nconst $f0d3351cfec6cf4a$var$u_impulse_loc = $f0d3351cfec6cf4a$var$gl.getUniformLocation($f0d3351cfec6cf4a$var$update_program, \"u_impulse\");\nconst $f0d3351cfec6cf4a$var$old_b_locs = (0, $e28a0cada894885c$export$9f0c37400c701bee)($f0d3351cfec6cf4a$var$n_balls, (k)=>{\n    return $f0d3351cfec6cf4a$var$gl.getAttribLocation($f0d3351cfec6cf4a$var$update_program, `old_b${k}`);\n});\nconst $f0d3351cfec6cf4a$var$vao_update_1to2 = $f0d3351cfec6cf4a$var$gl.createVertexArray();\n$f0d3351cfec6cf4a$var$gl.bindVertexArray($f0d3351cfec6cf4a$var$vao_update_1to2);\n$f0d3351cfec6cf4a$var$gl.bindBuffer($f0d3351cfec6cf4a$var$gl.ARRAY_BUFFER, $f0d3351cfec6cf4a$var$balldata_gpu_1);\nfor(let k = 0; k < $f0d3351cfec6cf4a$var$n_balls; k++){\n    $f0d3351cfec6cf4a$var$gl.enableVertexAttribArray($f0d3351cfec6cf4a$var$old_b_locs[k]);\n    $f0d3351cfec6cf4a$var$gl.vertexAttribPointer($f0d3351cfec6cf4a$var$old_b_locs[k], 4, $f0d3351cfec6cf4a$var$gl.FLOAT, false, $f0d3351cfec6cf4a$var$n_balls * 16, 16 * k);\n}\nconst $f0d3351cfec6cf4a$var$vao_update_2to1 = $f0d3351cfec6cf4a$var$gl.createVertexArray();\n$f0d3351cfec6cf4a$var$gl.bindVertexArray($f0d3351cfec6cf4a$var$vao_update_2to1);\n$f0d3351cfec6cf4a$var$gl.bindBuffer($f0d3351cfec6cf4a$var$gl.ARRAY_BUFFER, $f0d3351cfec6cf4a$var$balldata_gpu_2);\nfor(let k = 0; k < $f0d3351cfec6cf4a$var$n_balls; k++){\n    $f0d3351cfec6cf4a$var$gl.enableVertexAttribArray($f0d3351cfec6cf4a$var$old_b_locs[k]);\n    $f0d3351cfec6cf4a$var$gl.vertexAttribPointer($f0d3351cfec6cf4a$var$old_b_locs[k], 4, $f0d3351cfec6cf4a$var$gl.FLOAT, false, $f0d3351cfec6cf4a$var$n_balls * 16, 16 * k);\n}\n$f0d3351cfec6cf4a$var$gl.bindVertexArray(null);\nconst $f0d3351cfec6cf4a$var$tf_2to1 = $f0d3351cfec6cf4a$var$gl.createTransformFeedback();\n$f0d3351cfec6cf4a$var$gl.bindTransformFeedback($f0d3351cfec6cf4a$var$gl.TRANSFORM_FEEDBACK, $f0d3351cfec6cf4a$var$tf_2to1);\n$f0d3351cfec6cf4a$var$gl.bindBufferBase($f0d3351cfec6cf4a$var$gl.TRANSFORM_FEEDBACK_BUFFER, 0, $f0d3351cfec6cf4a$var$balldata_gpu_1);\nconst $f0d3351cfec6cf4a$var$tf_1to2 = $f0d3351cfec6cf4a$var$gl.createTransformFeedback();\n$f0d3351cfec6cf4a$var$gl.bindTransformFeedback($f0d3351cfec6cf4a$var$gl.TRANSFORM_FEEDBACK, $f0d3351cfec6cf4a$var$tf_1to2);\n$f0d3351cfec6cf4a$var$gl.bindBufferBase($f0d3351cfec6cf4a$var$gl.TRANSFORM_FEEDBACK_BUFFER, 0, $f0d3351cfec6cf4a$var$balldata_gpu_2);\n// unbind left over stuff\n$f0d3351cfec6cf4a$var$gl.bindTransformFeedback($f0d3351cfec6cf4a$var$gl.TRANSFORM_FEEDBACK, null);\n$f0d3351cfec6cf4a$var$gl.bindBuffer($f0d3351cfec6cf4a$var$gl.ARRAY_BUFFER, null);\nlet $f0d3351cfec6cf4a$var$cur_buffers = {\n    update_vao: $f0d3351cfec6cf4a$var$vao_update_1to2,\n    tf: $f0d3351cfec6cf4a$var$tf_1to2,\n    draw_vao: $f0d3351cfec6cf4a$var$draw_2_vao.vertexArrayObject\n};\nlet $f0d3351cfec6cf4a$var$next_buffers = {\n    update_vao: $f0d3351cfec6cf4a$var$vao_update_2to1,\n    tf: $f0d3351cfec6cf4a$var$tf_2to1,\n    draw_vao: $f0d3351cfec6cf4a$var$draw_1_vao.vertexArrayObject\n};\nlet $f0d3351cfec6cf4a$var$last_click_pos = null;\nlet $f0d3351cfec6cf4a$var$pending_impulse = [\n    0,\n    0\n];\ndocument.addEventListener(\"mousedown\", (ev)=>{\n    $f0d3351cfec6cf4a$var$last_click_pos = [\n        ev.offsetX,\n        ev.offsetY\n    ];\n});\ndocument.addEventListener(\"mouseup\", (ev)=>{\n    let cur_pos = [\n        ev.offsetX,\n        ev.offsetY\n    ];\n    const force = .01;\n    $f0d3351cfec6cf4a$var$pending_impulse = [\n        -(cur_pos[0] - $f0d3351cfec6cf4a$var$last_click_pos[0]) * force,\n        (cur_pos[1] - $f0d3351cfec6cf4a$var$last_click_pos[1]) * force\n    ];\n    $f0d3351cfec6cf4a$var$last_click_pos = null;\n});\nlet $f0d3351cfec6cf4a$var$last_time = 0;\nfunction $f0d3351cfec6cf4a$var$update(cur_time) {\n    $f0d3351cfec6cf4a$var$stats.update();\n    if ($6MzNI.resizeCanvasToDisplaySize($f0d3351cfec6cf4a$var$canvas)) // on resize\n    $f0d3351cfec6cf4a$var$gl.viewport(0, 0, $f0d3351cfec6cf4a$var$gl.drawingBufferWidth, $f0d3351cfec6cf4a$var$gl.drawingBufferHeight);\n    let delta = cur_time - $f0d3351cfec6cf4a$var$last_time;\n    $f0d3351cfec6cf4a$var$last_time = cur_time;\n    // for debugging\n    // gl.bindBuffer(gl.ARRAY_BUFFER, balldata_gpu_2);\n    // gl.getBufferSubData(gl.ARRAY_BUFFER, 0, balldata_cpu);\n    // console.log(\"before: \", balldata_cpu);\n    // gl.bindBuffer(gl.ARRAY_BUFFER, null);\n    //// update\n    $f0d3351cfec6cf4a$var$gl.useProgram($f0d3351cfec6cf4a$var$update_program);\n    $f0d3351cfec6cf4a$var$gl.bindVertexArray($f0d3351cfec6cf4a$var$cur_buffers.update_vao);\n    $f0d3351cfec6cf4a$var$gl.uniform2f($f0d3351cfec6cf4a$var$u_impulse_loc, $f0d3351cfec6cf4a$var$pending_impulse[0], $f0d3351cfec6cf4a$var$pending_impulse[1]);\n    $f0d3351cfec6cf4a$var$gl.enable($f0d3351cfec6cf4a$var$gl.RASTERIZER_DISCARD);\n    $f0d3351cfec6cf4a$var$gl.bindTransformFeedback($f0d3351cfec6cf4a$var$gl.TRANSFORM_FEEDBACK, $f0d3351cfec6cf4a$var$cur_buffers.tf);\n    $f0d3351cfec6cf4a$var$gl.beginTransformFeedback($f0d3351cfec6cf4a$var$gl.POINTS);\n    $f0d3351cfec6cf4a$var$gl.drawArrays($f0d3351cfec6cf4a$var$gl.POINTS, 0, $f0d3351cfec6cf4a$var$n_universes);\n    $f0d3351cfec6cf4a$var$gl.endTransformFeedback();\n    $f0d3351cfec6cf4a$var$gl.disable($f0d3351cfec6cf4a$var$gl.RASTERIZER_DISCARD);\n    $f0d3351cfec6cf4a$var$gl.bindTransformFeedback($f0d3351cfec6cf4a$var$gl.TRANSFORM_FEEDBACK, null);\n    $f0d3351cfec6cf4a$var$pending_impulse = [\n        0,\n        0\n    ];\n    // for debugging\n    // gl.bindBuffer(gl.ARRAY_BUFFER, balldata_gpu_2);\n    // gl.getBufferSubData(gl.ARRAY_BUFFER, 0, balldata_cpu);\n    // console.log(\"after: \", balldata_cpu);\n    // gl.bindBuffer(gl.ARRAY_BUFFER, null);\n    //// draw\n    $f0d3351cfec6cf4a$var$gl.clear($f0d3351cfec6cf4a$var$gl.COLOR_BUFFER_BIT);\n    $f0d3351cfec6cf4a$var$gl.useProgram($f0d3351cfec6cf4a$var$draw_pinfo.program);\n    $f0d3351cfec6cf4a$var$gl.bindVertexArray($f0d3351cfec6cf4a$var$cur_buffers.draw_vao);\n    $f0d3351cfec6cf4a$var$gl.drawArrays($f0d3351cfec6cf4a$var$gl.POINTS, 0, $f0d3351cfec6cf4a$var$n_universes * $f0d3351cfec6cf4a$var$n_balls);\n    {\n        const temp = $f0d3351cfec6cf4a$var$cur_buffers;\n        $f0d3351cfec6cf4a$var$cur_buffers = $f0d3351cfec6cf4a$var$next_buffers;\n        $f0d3351cfec6cf4a$var$next_buffers = temp;\n    }\n    requestAnimationFrame($f0d3351cfec6cf4a$var$update);\n}\nrequestAnimationFrame($f0d3351cfec6cf4a$var$update);\n\n})();\n//# sourceMappingURL=index.23799194.js.map\n","import * as twgl from \"twgl.js\"\r\n\r\nimport Stats from \"stats.js\"\r\nimport { fromCount, fromRange } from \"../kommon/kommon\";\r\nvar stats = new Stats();\r\nstats.showPanel(0);\r\ndocument.body.appendChild(stats.dom);\r\n\r\n//// init\r\nconst canvas = document.querySelector(\"#c\")! as HTMLCanvasElement;\r\nconst gl = canvas.getContext(\"webgl2\", { alpha: false })!;\r\ngl.clearColor(0.5, 0.5, 0.75, 1.0);\r\ngl.enable(gl.BLEND);\r\ngl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);\r\n\r\n// game logic\r\nconst n_universes = 30_000;\r\nconst n_balls = 8;\r\nconst ball_r = .05;\r\nconst chaos = .01;\r\n\r\nconst update_program = twgl.createProgramFromSources(gl, [\r\n    // vs\r\n    `#version 300 es\r\n\r\n    precision highp float;\r\n\r\n    #define ball_r ${(ball_r).toFixed(10)}\r\n    #define bounce .9\r\n    #define drag .99\r\n    #define dt 0.01\r\n\r\n    ${fromCount(n_balls, i => {\r\n        return `in vec4 old_b${i}; out vec4 new_b${i};`\r\n    }).join(\"\\n\")}\r\n\r\n    uniform vec2 u_impulse;\r\n\r\n    // pos, vel for each ball\r\n    void collide(in vec4 b1, in vec4 b2, out vec4 r1, out vec4 r2) {\r\n        r1 = b1;\r\n        r2 = b2;\r\n\r\n        vec2 delta = b1.xy - b2.xy;\r\n        float distSq = dot(delta, delta);\r\n        if (distSq > 0.0 && distSq < 4.0 * ball_r * ball_r) {\r\n            float dist = sqrt(distSq);\r\n            // assumption: all balls have the same mass\r\n            // intuition: the balls exchange their momentum\r\n            // but only on the direction joining them\r\n\r\n            // 1. avoid overlap\r\n            float push = (2.0 * ball_r - dist) * .5 * bounce / dist;\r\n            r1.xy += delta * push;\r\n            r2.xy -= delta * push;\r\n\r\n            // 2. exchange momentums\r\n            vec2 momentum = delta * (dot(delta, b1.zw) - dot(delta, b2.zw)) / distSq;\r\n            r1.zw -= momentum;\r\n            r2.zw += momentum;\r\n        }        \r\n    }\r\n\r\n    vec4 individualUpdate(vec4 ball) {\r\n        // movement\r\n        vec4 res = vec4(ball.xy + dt * ball.zw, ball.zw);\r\n        // bounce\r\n        if (abs(res.x) > 1.0 - ball_r) {\r\n            res.x = sign(res.x) * (2.0 - 2.0 * ball_r) - ball.x;\r\n            res.z = -ball.z;\r\n        }\r\n        if (abs(res.y) > 1.0 - ball_r) {\r\n            res.y = sign(res.y) * (2.0 - 2.0 * ball_r) - ball.y;\r\n            res.w = -ball.w;\r\n        }\r\n        // drag\r\n        res.zw *= drag;\r\n        return res;\r\n    }\r\n\r\n    void main() {\r\n        new_b0 = individualUpdate(vec4(old_b0.xy, old_b0.zw + u_impulse));\r\n    ${fromRange(1, n_balls, i => {\r\n        return `new_b${i} = individualUpdate(old_b${i});`\r\n    }).join(\"\\n\")}\r\n        // collision\r\n        // generate this code:\r\n        // collide(new_b0, new_b1, new_b0, new_b1);\r\n        // collide(0, 2) ...\r\n        // collide(0, n_balls-1)\r\n        // collide(1, 2) ...\r\n        // collide(1, n_balls-1)\r\n        // ...\r\n        // collide(n_balls - 2, n_balls-1)\r\n    ${fromRange(0, n_balls, i => {\r\n        return fromRange(i + 1, n_balls, j => {\r\n            return `collide(new_b${i}, new_b${j}, new_b${i}, new_b${j});`;\r\n        }).join(\"\\n\");\r\n    }).join(\"\\n\")}\r\n    }\r\n    `,\r\n    // fs\r\n    `#version 300 es\r\n    precision highp float;\r\n\r\n    void main() {}\r\n    `\r\n], {\r\n    transformFeedbackVaryings: fromRange(0, n_balls, k => `new_b${k}`),\r\n    transformFeedbackMode: gl.INTERLEAVED_ATTRIBS,\r\n});\r\n\r\n// px,py,vx,vy for each ball\r\n// [b0px,b0py,b0vx,b0vy,b1...,b2...,b0px,b0py,b0vx,b0vy,b1...,b2...,....]\r\nconst balldata_cpu = new Float32Array(n_universes * n_balls * 4);\r\nfor (let b = 0; b < n_balls; b++) {\r\n    let start_px = (Math.random() - .5) * (2 - ball_r);\r\n    let start_py = (Math.random() - .5) * (2 - ball_r);\r\n    for (let k = 0; k < n_universes; k++) {\r\n        let base_index = (k * n_balls + b) * 4;\r\n        balldata_cpu[base_index + 0] = start_px;\r\n        balldata_cpu[base_index + 1] = start_py;\r\n    }\r\n}\r\n// initial chaos\r\nfor (let k = 0; k < n_universes; k++) {\r\n    const ang = Math.PI * 2 * k / n_universes;\r\n    balldata_cpu[k * n_balls * 4 + 0] += Math.cos(ang) * chaos;\r\n    balldata_cpu[k * n_balls * 4 + 1] += Math.sin(ang) * chaos;\r\n}\r\n\r\n// double buffer pattern\r\nconst balldata_gpu_1 = twgl.createBufferFromTypedArray(gl, balldata_cpu, gl.ARRAY_BUFFER, gl.DYNAMIC_DRAW);\r\nconst balldata_gpu_2 = twgl.createBufferFromTypedArray(gl, balldata_cpu, gl.ARRAY_BUFFER, gl.DYNAMIC_DRAW);\r\n\r\nconst draw_pinfo = twgl.createProgramInfo(gl, [\r\n    // vs\r\n    `#version 300 es\r\n\r\n    #define n_balls ${(n_balls).toFixed(10)}\r\n\r\n    in vec2 pos;\r\n\r\n    out vec3 v_ball_color;\r\n\r\n    vec3 hsl2rgb(in vec3 c) {\r\n        vec3 rgb = clamp( abs(mod(c.x*6.0+vec3(0.0,4.0,2.0),6.0)-3.0)-1.0, 0.0, 1.0 );\r\n        return c.z + c.y * (rgb-0.5)*(1.0-abs(2.0*c.z-1.0));\r\n    }\r\n\r\n\r\n    void main() {\r\n        gl_Position = vec4(pos, 0.0, 1.0);\r\n        gl_PointSize = ${(gl.canvas.width * 2 * ball_r).toFixed(10)};\r\n        v_ball_color = hsl2rgb(vec3(float(gl_VertexID) / n_balls, 0.85, 0.5));\r\n        // v_ball_color = mix(vec3(1.0, 0, 0), vec3(0.0, 1, 0), mod(float(gl_VertexID), n_balls) / n_balls);\r\n    }\r\n    `,\r\n    // fs\r\n    `#version 300 es\r\n    precision highp float;\r\n\r\n    in vec3 v_ball_color;\r\n\r\n    out vec4 out_color;\r\n    \r\n    void main() {\r\n        float distSq = dot(gl_PointCoord - .5, gl_PointCoord - .5);\r\n        float alpha = smoothstep(.25, .20, distSq);\r\n        float outline = smoothstep(.27, .20, distSq);\r\n        out_color = vec4(v_ball_color * outline, alpha * .1);\r\n    }\r\n    `\r\n]);\r\n\r\nconst draw_1_vao = twgl.createVertexArrayInfo(gl, draw_pinfo, twgl.createBufferInfoFromArrays(gl, {\r\n    pos: {\r\n        buffer: balldata_gpu_1,\r\n        numComponents: 2,\r\n        stride: 4 * 4, // in bytes\r\n        type: Float32Array,\r\n    },\r\n}));\r\nconst draw_2_vao = twgl.createVertexArrayInfo(gl, draw_pinfo, twgl.createBufferInfoFromArrays(gl, {\r\n    pos: {\r\n        buffer: balldata_gpu_2,\r\n        numComponents: 2,\r\n        stride: 4 * 4, // in bytes\r\n        type: Float32Array,\r\n    },\r\n}));\r\n\r\nconst u_impulse_loc = gl.getUniformLocation(update_program, \"u_impulse\");\r\nconst old_b_locs = fromCount(n_balls, k => {\r\n    return gl.getAttribLocation(update_program, `old_b${k}`);\r\n});\r\n\r\nconst vao_update_1to2 = gl.createVertexArray()!;\r\ngl.bindVertexArray(vao_update_1to2);\r\ngl.bindBuffer(gl.ARRAY_BUFFER, balldata_gpu_1);\r\nfor (let k = 0; k < n_balls; k++) {\r\n    gl.enableVertexAttribArray(old_b_locs[k]);\r\n    gl.vertexAttribPointer(old_b_locs[k],\r\n        4, // size\r\n        gl.FLOAT,\r\n        false, // normalize\r\n        n_balls * 4 * 4, // stride in bytes, each universe is has n_balls*4 float32\r\n        16 * k, // offset in bytes\r\n    )\r\n}\r\n\r\nconst vao_update_2to1 = gl.createVertexArray()!;\r\ngl.bindVertexArray(vao_update_2to1);\r\ngl.bindBuffer(gl.ARRAY_BUFFER, balldata_gpu_2);\r\nfor (let k = 0; k < n_balls; k++) {\r\n    gl.enableVertexAttribArray(old_b_locs[k]);\r\n    gl.vertexAttribPointer(old_b_locs[k],\r\n        4, // size\r\n        gl.FLOAT,\r\n        false, // normalize\r\n        n_balls * 4 * 4, // stride in bytes, each universe is has n_balls*4 float32\r\n        16 * k, // offset in bytes\r\n    )\r\n}\r\n\r\ngl.bindVertexArray(null);\r\n\r\nconst tf_2to1 = gl.createTransformFeedback()!;\r\ngl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, tf_2to1);\r\ngl.bindBufferBase(gl.TRANSFORM_FEEDBACK_BUFFER, 0, balldata_gpu_1);\r\n\r\nconst tf_1to2 = gl.createTransformFeedback()!;\r\ngl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, tf_1to2);\r\ngl.bindBufferBase(gl.TRANSFORM_FEEDBACK_BUFFER, 0, balldata_gpu_2);\r\n\r\n// unbind left over stuff\r\ngl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, null);\r\ngl.bindBuffer(gl.ARRAY_BUFFER, null);\r\n\r\nlet cur_buffers = {\r\n    update_vao: vao_update_1to2, // read from position 1\r\n    tf: tf_1to2,                 // write to position 2\r\n    draw_vao: draw_2_vao.vertexArrayObject!,  // draw with position 2\r\n}\r\n\r\nlet next_buffers = {\r\n    update_vao: vao_update_2to1, // read from position 2\r\n    tf: tf_2to1,                 // write to position 1\r\n    draw_vao: draw_1_vao.vertexArrayObject!,  // draw with position 1\r\n}\r\n\r\ntype Vec2 = number[];\r\nlet last_click_pos: Vec2 | null = null;\r\nlet pending_impulse: Vec2 = [0, 0];\r\n\r\ndocument.addEventListener(\"mousedown\", ev => {\r\n    last_click_pos = [ev.offsetX, ev.offsetY];\r\n});\r\n\r\ndocument.addEventListener(\"mouseup\", ev => {\r\n    let cur_pos = [ev.offsetX, ev.offsetY];\r\n    const force = .01;\r\n    pending_impulse = [-(cur_pos[0] - last_click_pos![0]) * force, (cur_pos[1] - last_click_pos![1]) * force];\r\n    last_click_pos = null;\r\n})\r\n\r\nlet last_time = 0;\r\nfunction update(cur_time) {\r\n    stats.update();\r\n    if (twgl.resizeCanvasToDisplaySize(canvas)) {\r\n        // on resize\r\n        gl.viewport(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight);\r\n    }\r\n    let delta = cur_time - last_time;\r\n    last_time = cur_time;\r\n\r\n    // for debugging\r\n    // gl.bindBuffer(gl.ARRAY_BUFFER, balldata_gpu_2);\r\n    // gl.getBufferSubData(gl.ARRAY_BUFFER, 0, balldata_cpu);\r\n    // console.log(\"before: \", balldata_cpu);\r\n    // gl.bindBuffer(gl.ARRAY_BUFFER, null);\r\n\r\n    //// update\r\n    gl.useProgram(update_program);\r\n    gl.bindVertexArray(cur_buffers.update_vao);\r\n    gl.uniform2f(u_impulse_loc, pending_impulse[0], pending_impulse[1]);\r\n    gl.enable(gl.RASTERIZER_DISCARD);\r\n    gl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, cur_buffers.tf);\r\n    gl.beginTransformFeedback(gl.POINTS);\r\n    gl.drawArrays(gl.POINTS, 0, n_universes);\r\n    gl.endTransformFeedback();\r\n    gl.disable(gl.RASTERIZER_DISCARD);\r\n    gl.bindTransformFeedback(gl.TRANSFORM_FEEDBACK, null);\r\n\r\n    pending_impulse = [0, 0];\r\n\r\n    // for debugging\r\n    // gl.bindBuffer(gl.ARRAY_BUFFER, balldata_gpu_2);\r\n    // gl.getBufferSubData(gl.ARRAY_BUFFER, 0, balldata_cpu);\r\n    // console.log(\"after: \", balldata_cpu);\r\n    // gl.bindBuffer(gl.ARRAY_BUFFER, null);\r\n\r\n    //// draw\r\n    gl.clear(gl.COLOR_BUFFER_BIT);\r\n\r\n    gl.useProgram(draw_pinfo.program);\r\n    gl.bindVertexArray(cur_buffers.draw_vao);\r\n    gl.drawArrays(gl.POINTS, 0, n_universes * n_balls);\r\n\r\n    {\r\n        const temp = cur_buffers;\r\n        cur_buffers = next_buffers;\r\n        next_buffers = temp;\r\n    }\r\n\r\n    requestAnimationFrame(update);\r\n}\r\n\r\nrequestAnimationFrame(update);\r\n","// stats.js - http://github.com/mrdoob/stats.js\n(function(f,e){\"object\"===typeof exports&&\"undefined\"!==typeof module?module.exports=e():\"function\"===typeof define&&define.amd?define(e):f.Stats=e()})(this,function(){var f=function(){function e(a){c.appendChild(a.dom);return a}function u(a){for(var d=0;d<c.children.length;d++)c.children[d].style.display=d===a?\"block\":\"none\";l=a}var l=0,c=document.createElement(\"div\");c.style.cssText=\"position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000\";c.addEventListener(\"click\",function(a){a.preventDefault();\nu(++l%c.children.length)},!1);var k=(performance||Date).now(),g=k,a=0,r=e(new f.Panel(\"FPS\",\"#0ff\",\"#002\")),h=e(new f.Panel(\"MS\",\"#0f0\",\"#020\"));if(self.performance&&self.performance.memory)var t=e(new f.Panel(\"MB\",\"#f08\",\"#201\"));u(0);return{REVISION:16,dom:c,addPanel:e,showPanel:u,begin:function(){k=(performance||Date).now()},end:function(){a++;var c=(performance||Date).now();h.update(c-k,200);if(c>g+1E3&&(r.update(1E3*a/(c-g),100),g=c,a=0,t)){var d=performance.memory;t.update(d.usedJSHeapSize/\n1048576,d.jsHeapSizeLimit/1048576)}return c},update:function(){k=this.end()},domElement:c,setMode:u}};f.Panel=function(e,f,l){var c=Infinity,k=0,g=Math.round,a=g(window.devicePixelRatio||1),r=80*a,h=48*a,t=3*a,v=2*a,d=3*a,m=15*a,n=74*a,p=30*a,q=document.createElement(\"canvas\");q.width=r;q.height=h;q.style.cssText=\"width:80px;height:48px\";var b=q.getContext(\"2d\");b.font=\"bold \"+9*a+\"px Helvetica,Arial,sans-serif\";b.textBaseline=\"top\";b.fillStyle=l;b.fillRect(0,0,r,h);b.fillStyle=f;b.fillText(e,t,v);\nb.fillRect(d,m,n,p);b.fillStyle=l;b.globalAlpha=.9;b.fillRect(d,m,n,p);return{dom:q,update:function(h,w){c=Math.min(c,h);k=Math.max(k,h);b.fillStyle=l;b.globalAlpha=1;b.fillRect(0,0,r,m);b.fillStyle=f;b.fillText(g(h)+\" \"+e+\" (\"+g(c)+\"-\"+g(k)+\")\",t,v);b.drawImage(q,d+a,m,n-a,p,d,m,n-a,p);b.fillRect(d+n-a,m,a,p);b.fillStyle=l;b.globalAlpha=.9;b.fillRect(d+n-a,m,a,g((1-h/w)*p))}}};return f});\n","export function fromCount<T>(n: number, callback: (index: number) => T): T[] {\r\n    let result = Array(n);\r\n    for (let k = 0; k < n; k++) {\r\n        result[k] = callback(k);\r\n    }\r\n    return result;\r\n}\r\n\r\nexport function fromRange<T>(lo: number, hi: number, callback: (index: number) => T): T[] {\r\n    let count = hi - lo;\r\n    let result = Array(count);\r\n    for (let k = 0; k < count; k++) {\r\n        result[k] = callback(k + lo);\r\n    }\r\n    return result;\r\n}\r\n\r\nexport function* zip(...arrays: Iterable<any>[]): Generator<any> {\r\n    let iterators = arrays.map(a => a[Symbol.iterator]());\r\n    while (true) {\r\n        let nexts = iterators.map(a => a.next());\r\n        let done = nexts.some(n => n.done);\r\n        if (done) return;\r\n        yield nexts.map(n => n.value);\r\n    }\r\n}\r\n\r\nexport function objectMap<T, S>(object: Record<string, T>, map_fn: (x: T) => S): Record<string, S> {\r\n    let result: Record<string, S> = {};\r\n    for (let [k, v] of Object.entries(object)) {\r\n        result[k] = map_fn(v);\r\n    }\r\n    return result;\r\n}\r\n\r\nexport class DefaultDict<T> {\r\n    constructor(init_fn: () => T) {\r\n        // typing doesn't work :(\r\n        let target: Record<string | symbol | number, T> = {};\r\n        return new Proxy(target, {\r\n            get: (target, name): T => {\r\n                if (name in target) {\r\n                    return target[name];\r\n                } else {\r\n                    target[name] = init_fn();\r\n                    return target[name];\r\n                }\r\n            }\r\n        })\r\n    }\r\n}\r\n"],"names":["f","a","$parcel$global","globalThis","self","window","global","$parcel$modules","$parcel$inits","parcelRequire","id","exports","init","module","call","err","Error","code","register","$6MzNI","$a759912a70d9e191$exports","$e28a0cada894885c$export$9f0c37400c701bee","n","callback","result","Array","k","$e28a0cada894885c$export$f01e84010c13cebe","lo","hi","count","$f0d3351cfec6cf4a$var$stats","e","c","appendChild","dom","u","d","children","length","style","display","l","document","createElement","cssText","addEventListener","preventDefault","performance","Date","now","g","r","Panel","h","memory","t","REVISION","addPanel","showPanel","begin","end","update","usedJSHeapSize","jsHeapSizeLimit","domElement","setMode","Infinity","Math","round","devicePixelRatio","v","m","p","q","width","height","b","getContext","font","textBaseline","fillStyle","fillRect","fillText","globalAlpha","w","min","max","drawImage","__esModule","default","body","$f0d3351cfec6cf4a$var$canvas","querySelector","$f0d3351cfec6cf4a$var$gl","alpha","clearColor","enable","BLEND","blendFunc","SRC_ALPHA","ONE_MINUS_SRC_ALPHA","$f0d3351cfec6cf4a$var$update_program","createProgramFromSources","$f0d3351cfec6cf4a$var$ball_r","toFixed","i","join","j","transformFeedbackVaryings","transformFeedbackMode","INTERLEAVED_ATTRIBS","$f0d3351cfec6cf4a$var$balldata_cpu","Float32Array","$f0d3351cfec6cf4a$var$n_universes","start_px","random","start_py","base_index","ang","PI","cos","sin","$f0d3351cfec6cf4a$var$balldata_gpu_1","createBufferFromTypedArray","ARRAY_BUFFER","DYNAMIC_DRAW","$f0d3351cfec6cf4a$var$balldata_gpu_2","$f0d3351cfec6cf4a$var$draw_pinfo","createProgramInfo","$f0d3351cfec6cf4a$var$n_balls","canvas","$f0d3351cfec6cf4a$var$draw_1_vao","createVertexArrayInfo","createBufferInfoFromArrays","pos","buffer","numComponents","stride","type","$f0d3351cfec6cf4a$var$draw_2_vao","$f0d3351cfec6cf4a$var$u_impulse_loc","getUniformLocation","$f0d3351cfec6cf4a$var$old_b_locs","getAttribLocation","$f0d3351cfec6cf4a$var$vao_update_1to2","createVertexArray","bindVertexArray","bindBuffer","enableVertexAttribArray","vertexAttribPointer","FLOAT","$f0d3351cfec6cf4a$var$vao_update_2to1","$f0d3351cfec6cf4a$var$tf_2to1","createTransformFeedback","bindTransformFeedback","TRANSFORM_FEEDBACK","bindBufferBase","TRANSFORM_FEEDBACK_BUFFER","$f0d3351cfec6cf4a$var$tf_1to2","$f0d3351cfec6cf4a$var$cur_buffers","update_vao","tf","draw_vao","vertexArrayObject","$f0d3351cfec6cf4a$var$next_buffers","$f0d3351cfec6cf4a$var$last_click_pos","$f0d3351cfec6cf4a$var$pending_impulse","ev","offsetX","offsetY","cur_pos","requestAnimationFrame","$f0d3351cfec6cf4a$var$update","cur_time","resizeCanvasToDisplaySize","viewport","drawingBufferWidth","drawingBufferHeight","useProgram","uniform2f","RASTERIZER_DISCARD","beginTransformFeedback","POINTS","drawArrays","endTransformFeedback","disable","clear","COLOR_BUFFER_BIT","program","temp"],"version":3,"file":"index.23799194.js.map"}